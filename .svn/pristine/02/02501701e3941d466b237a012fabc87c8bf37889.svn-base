
@{
    ViewBag.Title = "ViewDischarge";
    Layout = "~/Views/Shared/_CommonLayout.cshtml";
}
<style type="text/css">
    tr.highlight td.jsgrid-cell {
        background-color: lightgoldenrodyellow;
    }

    .jsgrid-grid-header,
    .jsgrid-grid-body {
        overflow: auto;
    }
</style>
<script type="text/javascript">
    $(document).ready(function () {
        $('#path').html('Discharge List');
        $('.datepicker').datepicker({
            format: 'dd M yyyy',
            endDate: 'today',
            autoclose: true
        }); //code for datepicker
        var d = new Date();
        var currMonth = d.getMonth();
        var currYear = d.getFullYear();
        var startDate = new Date(currYear, currMonth, 1);
        $("#FrmDt").datepicker("setDate", startDate);
        $("#ToDt").datepicker("setDate", (new Date().toDateString()));
        dischargeDetails();
        $('#btnSearch').click(function () {
                if (validate()) {
                    dischargeDetails();
                }
        });
        $('#ddlRows').change(function () {
            if ($("option:selected", $("#ddlRows")).val() == '1') {
                $("#jsGrid").jsGrid({ pageSize: 10 });
            }
            else if ($("option:selected", $("#ddlRows")).val() == '2') {
                $("#jsGrid").jsGrid({ pageSize: 20 });
            }
            else if ($("option:selected", $("#ddlRows")).val() == '3') {
                $("#jsGrid").jsGrid({ pageSize: 50 });
            }
            else if ($("option:selected", $("#ddlRows")).val() == '4') {
                $("#jsGrid").jsGrid({ pageSize: 100 });
            }
            else if ($("option:selected", $("#ddlRows")).val() == '5') {
                $("#jsGrid").jsGrid({ pageSize: 200 });
            }
            else if ($("option:selected", $("#ddlRows")).val() == '6') {
                $("#jsGrid").jsGrid({ pageSize: 500 });
            }
        });
    });
    function dischargeDetails() {
        var arrDichargePackage = [];
        $('#jsGrid').jsGrid({
            width: "100%",
            sorting: true,
            paging: true,
            pageSize: 10,
            pageButtonCount: 10,
            pagerFormat: "Pages: {first} {prev} {pages} {next} {last} &nbsp;&nbsp; {pageIndex} of {pageCount} &nbsp;&nbsp; Total rows: {itemCount}",
            autoload: true,
            rowClick: function (args) {
                //console.log(args)
                var $row = this.rowByItem(args.item),
                    selectedRow = $("#jsGrid").find('table tr.highlight');
                if (selectedRow.length) {
                    selectedRow.toggleClass('highlight');
                };

                $row.toggleClass("highlight");
            },
            controller: {
                loadData: function () {
                    var d = $.Deferred();
                    var DischargeParams = {
                        HospitalCode: '@Session["HospitalCode"]',
                        Action: 'A',
                        URN: $('#urnNo').val()
                    };
                    return $.ajax({
                        url: ServiceURL + "/api/Registration/GetDischargeSummary",
                        type: "GET",
                        data: DischargeParams,
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        error: function (error) {
                            console.log(error.statusText);
                        },
                    }).done(function (result) {
                        //  console.log(result);
                        if (result.length > 0) {
                            $('#divRowCount').show();
                            d.resolve($.map(result, function (item, itemIndex) {
                                return $.extend(item, { "Index": itemIndex + 1 });
                            }
                            ));
                        }
                        else {
                            $('#divRowCount').hide();
                        }
                    });
                    return d.promise();
                }
            },
            fields: [
                { name: "Index", type: "number", width: 30, title: "#Sl", align: "center" },
                { name: "id", title: "id", type: "number", visible: false },
                { name: "urn", type: "text", title: "HIMCARE No.", align: "center" },
                { name: "cardNo", type: "text", title: "Card No.", align: "center", visible: false },
                { name: "patientName", type: "text", title: "Name", align: "center" },
                { name: "blockingInvoiceNo", type: "text", title: "Invoice No.", align: "center" },
                { name: "registrationUserDate", type: "number", title: "Registration Date", align: "center" },
                { name: "patientContactNumber", type: "number", title: "Contact Number", align: "center" },
                { name: "referalStatus", type: "number", title: "ReferalStatus", align: "center",visible: false  },
                {
                     type: "control", editButton: false, deleteButton: false, align: "center", width: "86",
                     itemTemplate: function (value, item) {
                         return $("<button>").attr({ type: "button", class: "btn btn-outline-primary focusedBtn btn-sm my-2 my-sm-0" }).text("Treatment Completion Certificate")
                             .on("click", function () {
                                 var windowName = "PrintPage";
                                 var wOption = "width=1350,height=650,menubar=yes,scrollbars=yes,location=no,left=100,top=100";
                                 var wWinPrint = window.open("", windowName, wOption);
                                 var arrBlockPackage = [];
                                 arrBlockPackage.push({
                                     urn: item.urn,
                                     invoiceNo: item.blockingInvoiceNo,
                                     TransactionID: item.id
                                 })
                                 localStorage.setItem('PrevBlockPackageInfo', JSON.stringify(arrBlockPackage));
                                 wWinPrint.location.href = '@Url.Action("TreatmentCompletionCertificate", "Discharge")';
                                 wWinPrint.focus();
                                 return wWinPrint;
                             });
                     },
                     headerTemplate: function () {
                         return $("<div>").prop("title", "Action").text("Discharge Slip");
                     }
                },
                {
                    type: "control", editButton: false, deleteButton: false, align: "center",
                    itemTemplate: function (value, item) {
                        return $("<button>").attr({ type: "button", class: "btn btn-outline-dark focusedBtn btn-sm my-2 my-sm-0" }).text("Referal")
                            .on("click", function () {
                                if (item.referalStatus > 0) {
                                    if (confirm("Already Downward Referal Submited. do you want to edit?")) {
                                        // alert('Already Downward Referal Submited.');
                                         arrDichargePackage.push({
                                           urn: item.urn,
                                           blockingInvoiceNo: item.blockingInvoiceNo
                                         })
                                         localStorage.setItem('DischargeInfo', JSON.stringify(arrDichargePackage));
                                         window.location.href = '@Url.Action("AddDownWard", "Discharge")';
                                    }
                                    else {
                                        return false;
                                    }
                                }
                                else {
                                    arrDichargePackage.push({
                                    urn: item.urn,
                                    blockingInvoiceNo: item.blockingInvoiceNo
                                    })
                                   localStorage.setItem('DischargeInfo', JSON.stringify(arrDichargePackage));
                                   window.location.href = '@Url.Action("AddDownWard", "Discharge")';
                                }
                               
                            });
                    },
                    headerTemplate: function () {
                        return $("<div>").prop("title", "Action").text("Downward Referal");
                    }
                },
                { type: "control", editButton: false, deleteButton: false,  align: "center",
                    itemTemplate: function (value, item) {
                        if (item.referalStatus > 0) {
                            return $("<button>").attr({ type: "button", class: "btn btn-outline-success focusedBtn btn-sm my-2 my-sm-0" }).text("Discharge")
                             .on("click", function () {
                                     arrDichargePackage.push({
                                         urn: item.urn,
                                         blockingInvoiceNo: item.blockingInvoiceNo
                                     })
                                     localStorage.setItem('DischargeInfo', JSON.stringify(arrDichargePackage));
                                     window.location.href = '@Url.Action("AddDischarge", "Discharge")';                                
                             });
                        }
                        else {
                            return false;
                        }
                    },
                        headerTemplate: function () {
                            return $("<div>").prop("title", "Action").text("Action");
                        }
                    }
             ]
        });
    }
    function isNumber(evt) {
        evt = (evt) ? evt : window.event;
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }
    function validate() {
        //if ($('#FrmDt').val() == "") {
        //    alert('Please Enter From Date !!');
        //    $('#FrmDt').focus();
        //    return false;
        //}
        //else if ($('#ToDt').val() == "") {
        //    alert('Please Enter To Date !!');
        //    $('#ToDt').focus();
        //    return false;
        //}
        if ($('#urnNo').val() == '') {
            alert('Please Enter URN !!');
            $('#urnNo').focus();
            return false;
        }
        else {
            return true;
        }
    }
</script>
<div class="container-fluid">
    <div class="row">
        <div class="col-12 pb-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <form class="filter-wrapper">
                                <div class="form-group row">
                                    <label for="packageHeader" class="col-sm-1 col-form-label">HIMCARE No.</label>
                                    <div class="col-sm-2">
                                        <input type="text" class="form-control" autofocus id="urnNo" placeholder="Enter here" maxlength="17" onkeypress="return isNumber(event)" />
                                    </div>
                                    @*<label for="packageHeader" class="col-sm-2 col-form-label">From Date</label>
                        <div class="col-sm-2">
                            <div class="input-group mb-3">
                                <input type="text" id="FrmDt" class="form-control datepicker" placeholder="dd mmm yyyy" aria-label="Username" aria-describedby="basic-addon1" maxlength="11">
                                <div class="input-group-prepend">
                                    <label for="blockingDt" class="input-group-text"><i class="icon-calendar"></i></label>
                                </div>
                            </div>
                        </div>
                        <label for="packageHeader" class="col-sm-2 col-form-label">To Date</label>
                        <div class="col-sm-2">
                            <div class="input-group mb-3">
                                <input type="text" id="ToDt" class="form-control datepicker" placeholder="dd mmm yyyy" aria-label="Username" aria-describedby="basic-addon1" maxlength="11">
                                <div class="input-group-prepend">
                                    <label for="blockingDt" class="input-group-text"><i class="icon-calendar"></i></label>
                                </div>
                            </div>
                        </div>*@
                                    <div class="col-sm-1">
                                        <input class="btn btn-outline-success my-2 my-sm-0" type="button" value="Search" id="btnSearch">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <h5 style="color:red"  class="noPrint">Note : Before Discharge First Fill the Referal Form.</h5>
                    <div class="row" id="divRowCount">
                        <label for="Rows">&nbsp;&nbsp;&nbsp;Row count</label>
                        <div class="col-sm-1">
                            <select id="ddlRows">
                                <option value="1">10</option>
                                <option value="2">20</option>
                                <option value="3">50</option>
                                <option value="4">100</option>
                                <option value="5">200</option>
                                <option value="6">500</option>
                            </select>
                        </div>
                        <div class="col-sm-10"></div>
                    </div>
                    <div class="table table-striped table-bordered" id="jsGrid">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        $('.secondary-menu li a').tooltip();
    });
</script>

